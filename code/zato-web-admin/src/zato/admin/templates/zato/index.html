{% extends "zato/base.html" %}
{% load extras %}

{% block html_title %}Hello{% endblock %}


{% block head %}
    <script nonce="{{ CSP_NONCE }}" type="text/javascript" src="/static/jquery/jquery-3.7.1.js"></script>
    <script nonce="{{ CSP_NONCE }}" type="text/javascript" src="/static/jquery-ui-1.13.2/jquery-ui.js"></script>
    <script nonce="{{ CSP_NONCE }}" type="text/javascript" src="/static/jquery/jquery.cookie.js"></script>
    <script nonce="{{ CSP_NONCE }}" type="text/javascript" src="/static/jquery/jquery.getUrlParam.js"></script>
    <script nonce="{{ CSP_NONCE }}" type="text/javascript" src="/static/jquery/hide-show-password.js"></script>
    <script nonce="{{ CSP_NONCE }}" type="text/javascript" src="/static/js/stringformat.js"></script>
    <script nonce="{{ CSP_NONCE }}" type="text/javascript" src="/static/chosen/chosen.jquery.js"></script>

    {% comment %} This is used in common.js {% endcomment %}
    <script nonce="{{ CSP_NONCE }}" type="text/javascript" src="/static/js/underscore-min.js"></script>

    {% comment %} This is needed for its Class object {% endcomment %}
    <script nonce="{{ CSP_NONCE }}" type="text/javascript" src="/static/mootools/mootools.js"></script>

    <script nonce="{{ CSP_NONCE }}" type="text/javascript" src="/static/js/common.js"></script>
    <script nonce="{{ CSP_NONCE }}" type="text/javascript" src="/static/js/log_streaming.js"></script>

    <script nonce="{{ CSP_NONCE }}">
    </script>

    <link rel="stylesheet" media="screen" href="/static/chosen/chosen.css" />
    <link rel="stylesheet" type="text/css" href="/static/css/jquery.ui.custom.css">
    <link rel="stylesheet" media="screen" href="/static/css/formalize.css" />
    <link rel="stylesheet" media="screen" href="/static/css/navigation/pure-css-navigation.css" />


    {% comment %} Our CSS must come last {% endcomment %}
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="stylesheet" type="text/css" href="/static/css/in-app-updates.css">

    {% if items %}
        {% include "zato/css-titlebar-padding.html" %}
    {% endif %}

    <link rel="stylesheet" media="screen" href="/static/css/hide-show-password.css" />

    {% if zato_template_name == "zato/scheduler.html" %}

        <style type="text/css">
            .ui-dialog-titlebar {
                padding-bottom:-4px !important;
            }
        </style>

    {% elif zato_template_name == "zato/outgoing/amqp.html" %}

        <style type="text/css">
            .ui-dialog-titlebar {
                margin-bottom:-25px !important;
            }
        </style>

    {% elif zato_template_name == "zato/groups/index.html" %}

        <style type="text/css">
        .ui-dialog-titlebar {
            margin-bottom:0px !important;
        }
        </style>

    {% else %}

        {% if not items %}
            <style type="text/css">
                .ui-dialog-titlebar {
                    padding-bottom:10px !important;
                }
            </style>
        {% endif %}

    {% endif %}

    {% block "extra_css" %}
    {% endblock %}

    {% block "extra_js" %}
    {% endblock %}

    <script nonce="{{ CSP_NONCE }}">

        {% if user.is_authenticated %}
        // Let users close delete dialogs via the Esc key
        $(document).ready(function() {
            $(document).keyup(function(e) {
                if(e.keyCode === 27 || e.key === "Escape" || e.key === "Esc") {
                    $("#popup_cancel").click();
                }
            });
        });
        {% endif %}

        // Let users reveal password fields
        $(document).ready(function() {
            $('input[type="password"]').hidePassword(true);

            // Set grafana link href dynamically
            $('.grafana-link').attr('href', window.location.protocol + '//' + window.location.hostname + ':33033/dashboards').attr('target', '_blank');

            const centerAlignColumnNames = [
                'Active',
                'Auth type',
                'Client',
                'Client ID field',
                'Client secret field',
                'Current size',
                'Default',
                'Extend exp. on get',
                'Extend exp. on set',
                'Grant type',
                'Instance',
                'Internal',
                'Max size',
                'Max item size',
                'Members',
                'SAP router string',
                'System ID',
                'User',
                'Use TLS',
            ];

            const table = $('#data-table');
            const headerRow = table.find('thead tr').first();

            headerRow.find('th').each(function(colIndex) {
                const headerCell = $(this);
                const headerText = headerCell.find('a').text().trim();

                if(centerAlignColumnNames.includes(headerText)) {
                    headerCell.css('text-align', 'center');

                    // Adjust the header link to be properly centered
                    const headerLink = headerCell.find('a');
                    headerLink.css({
                        'text-align': 'center',
                        'display': 'block',
                        'padding-right': '0'
                    });

                    table.find('tbody tr').each(function() {
                        $(this).find('td').eq(colIndex).css('text-align', 'center');
                    });
                }
            });

            // Check for updates on page load
            console.log('[UPDATE-CHECK] Script loaded, about to call checkUpdateAvailability(true)');
            checkUpdateAvailability(true);
            console.log('[UPDATE-CHECK] checkUpdateAvailability(true) called');

            // Check every hour (3600000 ms)
            setInterval(function() {
                checkUpdateAvailability(false);
            }, 3600000);

        });

        // Apply update status to badge
        function applyUpdateStatus(updatesAvailable) {
            console.log('[UPDATE-BADGE] applyUpdateStatus called with updatesAvailable:', updatesAvailable);
            
            const badge = $('#update-status-badge');
            const text = $('#update-status-text');
            
            console.log('[UPDATE-BADGE] badge element:', badge.length > 0 ? 'found' : 'NOT FOUND');
            console.log('[UPDATE-BADGE] text element:', text.length > 0 ? 'found' : 'NOT FOUND');
            
            if (updatesAvailable) {
                console.log('[UPDATE-BADGE] Setting to "Updates available" with shine');
                text.text('‚≠ê Updates available');
                badge.addClass('with-shine');
            } else {
                console.log('[UPDATE-BADGE] Setting to "Up to date" without shine');
                text.text('Up to date');
                badge.removeClass('with-shine');
            }
            
            badge.addClass('loaded');
            console.log('[UPDATE-BADGE] Added "loaded" class, badge should now be visible');
            console.log('[UPDATE-BADGE] Final badge classes:', badge.attr('class'));
            console.log('[UPDATE-BADGE] Final text content:', text.text());
        }

        // Check for updates availability
        function checkUpdateAvailability(isInitialLoad) {
            console.log('[UPDATE-CHECK] checkUpdateAvailability called, isInitialLoad:', isInitialLoad);
            
            const cached = localStorage.getItem('zato_updates_available');
            console.log('[UPDATE-CHECK] localStorage value:', cached);
            
            if (isInitialLoad && cached !== null) {
                console.log('[UPDATE-CHECK] Using cached value, skipping AJAX call');
                const cachedBool = cached === 'true';
                console.log('[UPDATE-CHECK] Cached boolean value:', cachedBool);
                applyUpdateStatus(cachedBool);
                return;
            }
            
            console.log('[UPDATE-CHECK] Making AJAX call to check-availability endpoint');
            
            $.ajax({
                url: '/zato/updates/check-availability',
                type: 'GET',
                success: function(response) {
                    console.log('[UPDATE-CHECK] AJAX success, response:', response);
                    const updatesAvailable = response.updates_available;
                    console.log('[UPDATE-CHECK] Updates available:', updatesAvailable);
                    localStorage.setItem('zato_updates_available', updatesAvailable);
                    console.log('[UPDATE-CHECK] Saved to localStorage');
                    applyUpdateStatus(updatesAvailable);
                },
                error: function(xhr, status, error) {
                    console.log('[UPDATE-CHECK] AJAX error, xhr:', xhr, 'status:', status, 'error:', error);
                    localStorage.setItem('zato_updates_available', 'false');
                    console.log('[UPDATE-CHECK] Set localStorage to false due to error');
                    applyUpdateStatus(false);
                }
            });
        }

    </script>

{% endblock %}

{% block body %}
    <div>
        <div id="hd">
            <div id="console-header">&nbsp;<a href="https://zato.io/{% if user.is_authenticated %}?v={{ zato_version|cut:"Zato " }} {% endif %}" id="logo-link"><img src="/static/gfx/logo.svg" alt="Zato logo" style="padding-top:3px;padding-bottom:3px;width:60px;margin-left:-0.25rem"/></a>
            {% if user.is_authenticated %}
                <span id="logout" style="padding-top:10px">
                    <a class="status-badge header-badge" href="{% url 'in-app-updates' %}" id="update-status-badge">
                        <span id="update-status-text"></span>
                    </a>
                    <a class="top" href="{% url "account-settings-basic" %}">My settings</a>
                    <a class="top"  href="{% url "logout" %}">Log out ({{ user.username }})</a>
                </span>
            {% endif %}
            </div>

            {% if user.is_authenticated %}

            <div class="pure-css-nav">
                <nav class="menu">
                    <div class="nav-container">
                        <ul class="first-level left">
                            <li class="first-level" >
                                <a class="menu-link"  style="padding-left: 0.3rem" href="#">Services &darr;</a>
                                <ul>
                                    <li class="child"><a class="menu-link" href="{% url "service-ide" "service" "demo.my-service" %}?cluster={{ cluster_id|default:"1" }}">IDE</a></li>
                                    <li class="child"><a class="menu-link" href="{% url "service" %}?cluster={{ cluster_id|default:"1" }}">List services</a></li>
                                </ul>
                            </li>
                            <li class="first-level" style="padding-left: 0.3rem">
                                <a class="menu-link" href="#">Security &darr;</a>
                                <ul>
                                    <li class="child"><a class="menu-link" href="{% url "security-apikey" %}?cluster={{ cluster_id|default:"1" }}">API keys</a></li>
                                    <li class="child"><a class="menu-link" href="{% url "security-oauth-outconn-client-credentials" %}?cluster={{ cluster_id|default:"1" }}">Bearer tokens</a></li>
                                    <li class="child"><a class="menu-link" href="{% url "groups" "zato-api-creds" %}?cluster={{ cluster_id|default:"1" }}">Groups</a></li>
                                    <li class="child"><a class="menu-link" href="{% url "security-basic-auth" %}?cluster={{ cluster_id|default:"1" }}">HTTP Basic Auth</a></li>
                                    <li class="child"><a class="menu-link" href="{% url "security-ntlm" %}?cluster={{ cluster_id|default:"1" }}">NTLM</a></li>
                                </ul>
                            </li>
                            <li class="first-level">
                                <a class="menu-link" href="#">Connections &darr;</a>
                                <ul>
                                    <li class="child">
                                        <a class="menu-link" href="#">Channels &rarr;</a>
                                        <ul>
                                            <li class="child"><a class="menu-link" href="{% url "channel-amqp" %}?cluster={{ cluster_id|default:"1" }}">AMQP</a></li>
                                            <li class="child"><a class="menu-link" href="{% url "http-soap" %}?cluster={{ cluster_id|default:"1" }}&amp;connection=channel&amp;transport=plain_http">REST</a></li>
                                        </ul>
                                    </li>
                                    <li>
                                        <a class="menu-link" href="#">Outgoing &rarr;</a>
                                        <ul>
                                            <li class="child"><a class="menu-link" href="{% url "out-amqp" %}?cluster={{ cluster_id|default:"1" }}">AMQP</a></li>
                                            {% if False %}
                                            <li class="child"><a class="menu-link" href="{% url "out-ftp" %}?cluster={{ cluster_id|default:"1" }}">FTP</a></li>
                                            {% endif %}
                                            <li class="child"><a class="menu-link" href="{% url "out-ldap" %}?cluster={{ cluster_id|default:"1" }}&amp;type_=outconn-ldap">LDAP</a></li>
                                            {% if 0%}
                                            <li class="child"><a class="menu-link" href="{% url "out-mongodb" %}?cluster={{ cluster_id|default:"1" }}&amp;type_=outconn-mongodb">MongoDB</a></li>
                                            {% endif %}
                                            <li class="child"><a class="menu-link" href="{% url "out-odoo" %}?cluster={{ cluster_id|default:"1" }}">Odoo</a></li>
                                            <li class="child"><a class="menu-link" href="{% url "http-soap" %}?cluster={{ cluster_id|default:"1" }}&amp;connection=outgoing&amp;transport=plain_http">REST</a></li>
                                            {% if 0 %}
                                            <li class="child"><a class="menu-link" href="{% url "out-sap" %}?cluster={{ cluster_id|default:"1" }}">SAP RFC</a></li>
                                            {% endif %}
                                            <li class="child"><a class="menu-link" href="{% url "http-soap" %}?cluster={{ cluster_id|default:"1" }}&amp;connection=outgoing&amp;transport=soap">SOAP</a></li>
                                            <li class="child"><a class="menu-link" href="{% url "out-sql" %}?cluster={{ cluster_id|default:"1" }}">SQL</a></li>
                                        </ul>
                                    </li>
                                    <li>
                                        <a class="menu-link" href="{% url "cache-builtin" %}?cluster={{ cluster_id|default:"1" }}">Cache</a>
                                    </li>
                                    <li class="child">
                                        <a class="menu-link" href="#">Search &rarr;</a>
                                        <ul>
                                            <li class="child"><a class="menu-link" href="{% url "search-es" %}?cluster={{ cluster_id|default:"1" }}">ElasticSearch</a></li>
                                        </ul>
                                    </li>
                                    <li class="child">
                                        <a class="menu-link" href="#">E-mail &rarr;</a>
                                        <ul>
                                            <li class="child"><a class="menu-link" href="{% url "email-imap" %}?cluster={{ cluster_id|default:"1" }}">IMAP</a></li>
                                            <li class="child"><a class="menu-link" href="{% url "email-smtp" %}?cluster={{ cluster_id|default:"1" }}">SMTP</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li class="first-level">
                                <a class="menu-link" href="#">Cloud &darr;</a>
                                <ul>
                                    <li class="child">
                                        <a class="menu-link" href="#">Atlassian &rarr;</a>
                                        <ul>
                                            <li class="child">
                                                <a class="menu-link" href="{% url "cloud-confluence" %}?cluster={{ cluster_id|default:"1" }}&amp;type_=cloud-confluence">Confluence</a>
                                            </li>
                                            <li class="child">
                                                <a class="menu-link" href="{% url "cloud-jira" %}?cluster={{ cluster_id|default:"1" }}&amp;type_=cloud-jira">Jira</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="child"><a class="menu-link" href="{% url "cloud-microsoft-365" %}?cluster={{ cluster_id|default:"1" }}&amp;type_=cloud-aws">AWS</a></li>
                                    <li class="child"><a class="menu-link" href="{% url "cloud-microsoft-365" %}?cluster={{ cluster_id|default:"1" }}&amp;type_=cloud-aws">Google</a></li>
                                    <li class="child"><a class="menu-link" href="{% url "cloud-microsoft-365" %}?cluster={{ cluster_id|default:"1" }}&amp;type_=cloud-microsoft-365">Microsoft 365</a></li>
                                    <li class="child"><a class="menu-link" href="{% url "cloud-salesforce" %}?cluster={{ cluster_id|default:"1" }}&amp;type_=cloud-salesforce">Salesforce</a></li>
                                </ul>
                            </li>
                            <li class="first-level">
                                <a class="menu-link" href="#">Vendors &darr;</a>
                                <ul>
                                    {% if False %}
                                    <li class="child">
                                        <a class="menu-link" href="#">Amazon &rarr;</a>
                                        <ul>
                                            <li class="child">
                                                <a class="menu-link" href="{% url "cloud-aws-s3" %}?cluster={{ cluster_id|default:"1" }}">S3</a>
                                            </li>
                                        </ul>
                                    </li>
                                    {% endif %}
                                    <li class="child">
                                        <a class="menu-link" href="#">Atlassian &rarr;</a>
                                        <ul>
                                            <li class="child"><a class="menu-link" href="{% url "cloud-confluence" %}?cluster={{ cluster_id|default:"1" }}&amp;type_=cloud-confluence">Confluence</a></li>
                                            <li class="child"><a class="menu-link" href="{% url "cloud-jira" %}?cluster={{ cluster_id|default:"1" }}&amp;type_=cloud-jira">Jira</a></li>
                                        </ul>
                                    </li>
                                    <li class="child">
                                        <a class="menu-link" href="#">Keysight &rarr;</a>
                                        <ul>
                                            {% if False %}<li class="child"><a class="menu-link" href="#">Hawkeye</a></li>{% endif %}
                                            <li class="child"><a class="menu-link" href="{% url "vendors-keysight-vision" %}?cluster={{ cluster_id|default:"1" }}">Vision Series</a></li>
                                        </ul>
                                    </li>
                                    <li class="child">
                                        <a class="menu-link" href="#">Microsoft &rarr;</a>
                                        <ul>
                                            <li class="child">
                                                <a class="menu-link" href="#">365 &rarr;</a>
                                                <ul>
                                                    <li class="child">
                                                        <a class="menu-link" href="{% url "cloud-microsoft-365" %}?cluster={{ cluster_id|default:"1" }}&amp;type_=cloud-microsoft-365">Cloud</a>
                                                    </li>
                                                    <li class="child">
                                                        <a class="menu-link" href="{% url "email-imap" %}?cluster={{ cluster_id|default:"1" }}">IMAP</a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li class="child">
                                                <a class="menu-link" href="{% url "out-ldap" %}?cluster={{ cluster_id|default:"1" }}&amp;type_=outconn-ldap">LDAP (AD)</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="child"><a class="menu-link" href="{% url "cloud-salesforce" %}?cluster={{ cluster_id|default:"1" }}&amp;type_=cloud-salesforce">Salesforce</a></li>
                                    {% if 0 %}
                                    <li class="child"><a class="menu-link" href="{% url "out-sap" %}?cluster={{ cluster_id|default:"1" }}">SAP</a></li>
                                    {% endif %}
                                </ul>
                            </li>
                            <li class="first-level">
                                <a class="menu-link" href="#">EDA &darr;</a>
                                <ul>
                                    <li class="child"><a class="menu-link" href="{% url "pubsub-topic" %}?cluster={{ cluster_id|default:"1" }}">Topics</a></li>
                                    <li class="child"><a class="menu-link" href="{% url "pubsub-permission" %}?cluster={{ cluster_id|default:"1" }}">Permissions</a></li>
                                    <li class="child"><a class="menu-link" href="{% url "pubsub-subscription" %}?cluster={{ cluster_id|default:"1" }}">Subscriptions</a></li>
                                    <li class="child" style="border-top: 1px solid #246291"><a class="menu-link" href="javascript:$.fn.zato.pubsub.import_test_config()">Import test config</a></li>
                                    <li class="child"><a class="menu-link" href="javascript:$.fn.zato.pubsub.download_openapi()">Download OpenAPI</a></li>
                                </ul>
                            </li>

                            <li class="first-level"><a class="menu-link" href="{% url "scheduler" %}?cluster={{ cluster_id|default:"1" }}">Scheduler</a></li>

                            <li class="first-level" >
                                <a class="menu-link"  style="padding-left: 0.3rem" href="#">System &darr;</a>
                                <ul>
                                    <li class="child">
                                        <a class="menu-link" href="#">Config &rarr;</a>
                                        <ul>
                                            <li class="child"><a class="menu-link" href="javascript:$.fn.zato.service.import_config()">Import enmasse</a></li>
                                            <li class="child"><a class="menu-link" href="javascript:$.fn.zato.service.export_config()">Export enmasse</a></li>
                                        </ul>
                                    </li>
                                    <li class="child"><a class="menu-link" href="/zato/updates/">Install updates</a></li>
                                    <li class="child">
                                        <a class="menu-link" href="#">Log streaming &rarr;</a>
                                        <ul>
                                            <li class="child"><a class="menu-link" href="javascript:$.fn.zato.log_streaming.get_status()">Show status</a></li>
                                            <li class="child"><a class="menu-link" href="javascript:$.fn.zato.log_streaming.toggle()">Toggle streaming</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>

                            <li class="first-level">
                                <a class="menu-link" href="#">Observability &darr;</a>
                                <ul>
                                    <li class="child"><a class="menu-link" href="{% url "monitoring-config" %}?cluster={{ cluster_id|default:"1" }}">Config</a></li>
                                    <li class="child"><a class="menu-link grafana-link" href="#">Grafana</a></li>
                                    <li class="child"><a class="menu-link" href="javascript:alert('Opening Datadog dashboard...')">Datadog</a></li>
                                </ul>
                            </li>
                        </ul>
                        <ul class="first-level right">
                            <li class="first-level right"><a class="menu-link" href="https://zato.io/en/docs/3.2/index.html?v={{ zato_version|cut:"Zato " }}">Docs</a></li>
                            <li class="first-level right"><a class="menu-link" href="https://zato.io/en/blog/">Blog</a></li>
                            <li class="first-level right"><a class="menu-link" href="https://www.linkedin.com/company/zatosource/">LinkedIn</a></li>
                            <li class="first-level right"><a class="menu-link" href="https://zato.io/en/services/index.html">Support</a></li>
                        </ul>
                    </div>
                </nav>
            </div>
            <div id="cluster_color_div"
                {% if cluster_color %}
                    style="background-color:#{{ cluster_color }}"
                {% else %}
                    class="hidden"
                {% endif %}
                >&nbsp;</div>
        </div>

        {% endif %}

        <div id="bd">
        <div id="yui-main">
            <div class="yui-b">{% block "content" %}{% endblock %}</div>
        </div>
    </div>
</div>
{% endblock %}
