{% extends "zato/index.html" %}

{% block html_title %}Health monitoring wizard{% endblock %}

{% block "extra_css" %}
<script type="text/javascript" src="/static/tippy/popperjs.core.js"></script>
<script type="text/javascript" src="/static/tippy/tippy.js"></script>
<link rel="stylesheet" type="text/css" href="/static/zato/css/wizard.css">
{% endblock %}

{% block "extra_js" %}
<link rel="stylesheet" media="screen" href="/static/css/tippy.css" />
<script type="text/javascript" nonce="{{ CSP_NONCE }}">
    $(document).ready(function() {
        let currentStep = 1;
        const totalSteps = 3;
        let wizardData = {};

        function getURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                step: parseInt(urlParams.get('step')) || 1,
                step1: urlParams.get('step1') || '',
                step2: urlParams.get('step2') || '',
                step3: urlParams.get('step3') || ''
            };
        }

        function updateURL() {
            const params = new URLSearchParams();
            params.set('step', currentStep);
            if (wizardData.step1) params.set('step1', wizardData.step1);
            if (wizardData.step2) params.set('step2', wizardData.step2);
            if (wizardData.step3) params.set('step3', wizardData.step3);
            window.history.replaceState({}, '', '?' + params.toString());
        }

        function updateStepValues() {
            if (wizardData.step1) {
                $('#value-1 .step-value-text').text(wizardData.step1);
                $('#value-1').addClass('show');
            } else {
                $('#value-1').removeClass('show');
            }

            if (wizardData.step2) {
                const step2Text = $('#step-2 .option-item[data-value="' + wizardData.step2 + '"] .option-text').text();
                $('#value-2 .step-value-text').text(step2Text);
                $('#value-2').addClass('show');
            } else {
                $('#value-2').removeClass('show');
            }

            if (wizardData.step3) {
                const step3Text = $('#step-3 .option-item[data-value="' + wizardData.step3 + '"] .option-text').text();
                $('#value-3 .step-value-text').text(step3Text);
                $('#value-3').addClass('show');
            } else {
                $('#value-3').removeClass('show');
            }
        }

        function loadFromURL() {
            const urlData = getURLParams();
            currentStep = Math.min(Math.max(urlData.step, 1), totalSteps);
            wizardData = {
                step1: urlData.step1,
                step2: urlData.step2,
                step3: urlData.step3
            };

            if (wizardData.step1) {
                $('#step-1 input').val(wizardData.step1);
            }
            if (wizardData.step2) {
                $('#step-2 .option-item[data-value="' + wizardData.step2 + '"]').addClass('selected');
            }
            if (wizardData.step3) {
                $('#step-3 .option-item[data-value="' + wizardData.step3 + '"]').addClass('selected');
            }
            updateStepValues();
        }

        function updateStepper() {
            $('.step').each(function(index) {
                const stepNum = index + 1;
                $(this).removeClass('active completed');

                if (stepNum < currentStep) {
                    $(this).addClass('completed');
                } else if (stepNum === currentStep) {
                    $(this).addClass('active');
                }
            });
        }

        function showStep(step) {
            $('.wizard-step').hide();
            $('#step-' + step).show();

            $('.step-number').removeClass('active');
            $('.step-number').eq(step - 1).addClass('active');

            $('.step-value').removeClass('current');
            $('#value-' + step).addClass('current');

            if (step === 1) {
                $('#prev-button').hide();
                // Focus input on step 1
                setTimeout(() => {
                    $('#step-1 input, #step-1 textarea').first().focus();
                }, 100);
            } else {
                $('#prev-button').show();
            }

            // Update button text based on step
            if (step === totalSteps) {
                $('#next-button').text('Create Dashboard');
            } else {
                $('#next-button').text('Next');
            }

            updateURL();
        }

        $('.option-item').click(function() {
            const parent = $(this).parent();
            const stepDiv = $(this).closest('.wizard-step');
            const stepId = stepDiv.attr('id');
            const selectedValue = $(this).data('value');

            if ($(this).hasClass('selected')) {
                // Unselect if already selected
                $(this).removeClass('selected');
                if (stepId === 'step-2') {
                    delete wizardData.step2;
                    updateStepValues();
                } else if (stepId === 'step-3') {
                    delete wizardData.step3;
                    updateStepValues();
                }
            } else {
                // Select new item
                parent.find('.option-item').removeClass('selected');
                $(this).addClass('selected');

                if (stepId === 'step-2') {
                    wizardData.step2 = selectedValue;
                    updateStepValues();
                } else if (stepId === 'step-3') {
                    wizardData.step3 = selectedValue;
                    updateStepValues();
                }
            }
        });

        function goToNextStep() {
            console.log('=== CREATE DASHBOARD CLICKED ===');
            console.log('Current step:', JSON.stringify(currentStep));
            console.log('Total steps:', JSON.stringify(totalSteps));
            let isValid = false;
            let errorField = null;

            console.log('Checking validation for step:', JSON.stringify(currentStep));
            
            if (currentStep === 1) {
                console.log('Validating step 1 (input field)');
                const stepInput = $('#step-' + currentStep + ' input, #step-' + currentStep + ' textarea');
                if (stepInput.length && stepInput.val().trim()) {
                    wizardData['step' + currentStep] = stepInput.val().trim();
                    isValid = true;
                } else {
                    errorField = $('#step-' + currentStep + ' .input-wrapper');
                }
            } else {
                console.log('Validating step 2 or 3 (option selection)');
                const selectedOption = $('#step-' + currentStep + ' .option-item.selected');
                console.log('Selected options found:', JSON.stringify(selectedOption.length));
                if (selectedOption.length) {
                    wizardData['step' + currentStep] = selectedOption.data('value');
                    isValid = true;
                } else {
                    errorField = $('#step-' + currentStep + ' .option-item');
                }
            }
            
            console.log('Validation result - isValid:', JSON.stringify(isValid));
            console.log('Error field:', JSON.stringify(errorField ? 'has error field' : 'no error field'));

            if (isValid) {
                console.log('Current step is valid, updating step values');
                updateStepValues();

                if (currentStep < totalSteps) {
                    console.log('Moving to next step');
                    currentStep++;
                    showStep(currentStep);
                } else {
                    console.log('On final step and current step valid, checking ALL steps');
                    // Check all steps have values even if current step is valid
                    const step1Value = $('#step-1 input').val()?.trim() || '';
                    const step2Selected = $('#step-2 .option-item.selected').length > 0;
                    const step3Selected = $('#step-3 .option-item.selected').length > 0;
                    console.log('Final validation - all step values:', JSON.stringify({step1Value, step2Selected, step3Selected}));
                    
                    const missingSteps = [];
                    if (!step1Value) missingSteps.push('▶ 1. What do you want to monitor?');
                    if (!step2Selected) missingSteps.push('▶ 2. What do you want to track?');
                    if (!step3Selected) missingSteps.push('▶ 3. How far back to look?');
                    
                    console.log('Final validation - missing steps:', JSON.stringify(missingSteps));
                    
                    if (missingSteps.length > 0) {
                        console.log('Some steps still missing, showing tooltip');
                        const tooltipText = 'Please complete the following:<br>' + missingSteps.join('<br>');
                        console.log('Final tooltip text:', JSON.stringify(tooltipText));
                        
                        const button = document.getElementById('next-button');
                        if (button._tippy) {
                            console.log('Destroying existing final tooltip');
                            button._tippy.destroy();
                        }
                        
                        let _tooltip = tippy(button, {
                            content: tooltipText,
                            allowHTML: true,
                            theme: "dark",
                            trigger: "manual",
                            placement: "bottom",
                            arrow: true,
                            interactive: false,
                            inertia: true,
                            role: "tooltip-draw-attention",
                        });
                        
                        console.log('Final tooltip created:', JSON.stringify(_tooltip ? 'success' : 'failed'));
                        _tooltip.show();
                        console.log('Final tooltip shown');
                        $('#next-button').blur();
                    } else {
                        console.log('All steps truly completed');
                        alert('Wizard Complete!');
                    }
                }
            } else {
                console.log('Current step invalid, checking what to do');
                
                // If we're on the final step, check all steps for completion
                if (currentStep === totalSteps) {
                    console.log('On final step, checking all steps for completion');
                    // Check all steps have values
                    const step1Value = $('#step-1 input').val()?.trim() || '';
                    const step2Selected = $('#step-2 .option-item.selected').length > 0;
                    const step3Selected = $('#step-3 .option-item.selected').length > 0;
                    console.log('Step values check:', JSON.stringify({step1Value, step2Selected, step3Selected}));

                    console.log('Showing tooltip for any missing steps');
                    // Show tooltip for any missing steps
                    const missingSteps = [];
                    if (!step1Value) missingSteps.push('▶ 1. What do you want to monitor?');
                    if (!step2Selected) missingSteps.push('▶ 2. What do you want to track?');
                    if (!step3Selected) missingSteps.push('▶ 3. How far back to look?');

                    if (missingSteps.length > 0) {
                        console.log('Missing steps detected:', JSON.stringify(missingSteps));
                        const tooltipText = 'Please complete the following:<br>' + missingSteps.join('<br>');
                        console.log('Tooltip text:', JSON.stringify(tooltipText));
                        
                        // Destroy any existing tooltips first
                        const button = document.getElementById('next-button');
                        console.log('Button element:', JSON.stringify(button ? 'found' : 'not found'));
                        if (button._tippy) {
                            console.log('Destroying existing tooltip');
                            button._tippy.destroy();
                        }
                        
                        console.log('Creating new tooltip with tippy function:', JSON.stringify(typeof tippy));
                        
                        // Create new tooltip
                        let _tooltip = tippy(button, {
                            content: tooltipText,
                            allowHTML: true,
                            theme: "dark",
                            trigger: "manual",
                            placement: "bottom",
                            arrow: true,
                            interactive: false,
                            inertia: true,
                            role: "tooltip-draw-attention",
                        });
                        
                        console.log('Tooltip created:', JSON.stringify(_tooltip ? 'success' : 'failed'));
                        console.log('Calling show() on tooltip');
                        _tooltip.show();
                        console.log('Tooltip show() called');
                        $('#next-button').blur();
                    }
                } else if (errorField) {
                    console.log('Handling validation error for current step');
                    $('#next-button').blur();
                    
                    // Focus on the missing input field
                    if (currentStep === 1) {
                        const inputField = $('#step-1 input, #step-1 textarea').first();
                        if (inputField.length) {
                            setTimeout(() => {
                                inputField.focus();
                            }, 100);
                        }
                    }
                    
                    errorField.removeClass('field-error');
                    setTimeout(() => {
                        errorField.addClass('field-error');
                    }, 10);
                    setTimeout(() => {
                        errorField.removeClass('field-error');
                    }, 1600);
                }
            }
        }

        $('#next-button').click(goToNextStep);

        $('input.input-field').on('keypress', function(e) {
            if (e.which === 13) {
                goToNextStep();
            }
        });

        $('#step-1 input').on('input', function() {
            const value = $(this).val().trim();
            if (value) {
                wizardData.step1 = value;
                updateStepValues();
            } else {
                delete wizardData.step1;
                updateStepValues();
            }
        });

        $('#prev-button').click(function() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        });

        function focusStepInput(stepNumber) {
            if (stepNumber === 1) {
                $('#step-1 input').focus();
            } else if (stepNumber === 2 || stepNumber === 3) {
                $('#step-' + stepNumber + ' .option-group').focus();
            }
        }

        $('.step-number').click(function() {
            const stepIndex = $('.step-number').index(this) + 1;
            currentStep = stepIndex;
            showStep(currentStep);
            focusStepInput(currentStep);
        });

        $('.step-value').click(function() {
            const stepId = $(this).attr('id');
            const stepNumber = parseInt(stepId.split('-')[1]);
            currentStep = stepNumber;
            showStep(currentStep);
            focusStepInput(currentStep);
        });

        loadFromURL();
        showStep(currentStep);
    });
</script>
{% endblock %}

{% block "content" %}

<div class="wizard-container">
    <div class="wizard-panel">
        <div class="wizard-layout">
            <div class="stepper">
                <div class="step-value" id="value-1"><div class="step-value-text"></div><div class="step-arrow">▶</div></div>
                <div class="step-value" id="value-2"><div class="step-value-text"></div><div class="step-arrow">▶</div></div>
                <div class="step-value" id="value-3"><div class="step-value-text"></div><div class="step-arrow">▶</div></div>
                <h1 class="wizard-title">Is it working?</h1>
                <div class="step">
                    <div class="step-number">1</div>
                </div>
                <div class="step-connector"></div>
                <div class="step">
                    <div class="step-number">2</div>
                </div>
                <div class="step-connector"></div>
                <div class="step">
                    <div class="step-number">3</div>
                </div>
            </div>

            <div class="wizard-content">
            <div id="step-1" class="wizard-step">
                <h1 class="question-title">1. What do you want to monitor?</h1>
                <div class="input-wrapper">
                    <input type="text" class="input-field" placeholder="Enter what you want to monitor..." />
                </div>
            </div>

            <div id="step-2" class="wizard-step" style="display: none;">
                <h1 class="question-title">2. What do you want to track?</h1>
                <div class="option-group">
                    <div class="option-item" data-value="current-status">
                        <div class="option-radio"></div>
                        <div class="option-text">Current status</div>
                    </div>
                    <div class="option-item" data-value="error-rate">
                        <div class="option-radio"></div>
                        <div class="option-text">Error rate</div>
                    </div>
                    <div class="option-item" data-value="uptime">
                        <div class="option-radio"></div>
                        <div class="option-text">Uptime</div>
                    </div>
                    <div class="option-item" data-value="activity">
                        <div class="option-radio"></div>
                        <div class="option-text">Activity</div>
                    </div>
                </div>
            </div>

            <div id="step-3" class="wizard-step" style="display: none;">
                <h1 class="question-title">3. How far back to look?</h1>
                <div class="option-group">
                    <div class="option-item" data-value="real-time">
                        <div class="option-radio"></div>
                        <div class="option-text">Right now</div>
                    </div>
                    <div class="option-item" data-value="last-hour">
                        <div class="option-radio"></div>
                        <div class="option-text">Last hour</div>
                    </div>
                    <div class="option-item" data-value="last-day">
                        <div class="option-radio"></div>
                        <div class="option-text">Last day</div>
                    </div>
                    <div class="option-item" data-value="last-week">
                        <div class="option-radio"></div>
                        <div class="option-text">Last week</div>
                    </div>
                    <div class="option-item" data-value="last-month">
                        <div class="option-radio"></div>
                        <div class="option-text">Last month</div>
                    </div>
                </div>
            </div>

            <div class="wizard-buttons">
                <button id="prev-button" class="wizard-button">Previous</button>
                <button id="next-button" class="wizard-button">Next</button>
            </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
