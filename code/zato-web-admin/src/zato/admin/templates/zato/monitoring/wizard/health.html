{% extends "zato/index.html" %}

{% block html_title %}Health monitoring wizard{% endblock %}

{% block "extra_css" %}
<link rel="stylesheet" type="text/css" href="/static/zato/css/wizard.css">
{% endblock %}

{% block "extra_js" %}
<script type="text/javascript" nonce="{{ CSP_NONCE }}">
    $(document).ready(function() {
        let currentStep = 1;
        const totalSteps = 3;
        let wizardData = {};

        function getURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                step: parseInt(urlParams.get('step')) || 1,
                step1: urlParams.get('step1') || '',
                step2: urlParams.get('step2') || '',
                step3: urlParams.get('step3') || ''
            };
        }

        function updateURL() {
            const params = new URLSearchParams();
            params.set('step', currentStep);
            if (wizardData.step1) params.set('step1', wizardData.step1);
            if (wizardData.step2) params.set('step2', wizardData.step2);
            if (wizardData.step3) params.set('step3', wizardData.step3);
            window.history.replaceState({}, '', '?' + params.toString());
        }

        function updateStepValues() {
            if (wizardData.step1) {
                $('#value-1 .step-value-text').text(wizardData.step1);
                $('#value-1').addClass('show');
            } else {
                $('#value-1').removeClass('show');
            }
            
            if (wizardData.step2) {
                const step2Text = $('#step-2 .option-item[data-value="' + wizardData.step2 + '"] .option-text').text();
                $('#value-2 .step-value-text').text(step2Text);
                $('#value-2').addClass('show');
            } else {
                $('#value-2').removeClass('show');
            }
            
            if (wizardData.step3) {
                const step3Text = $('#step-3 .option-item[data-value="' + wizardData.step3 + '"] .option-text').text();
                $('#value-3 .step-value-text').text(step3Text);
                $('#value-3').addClass('show');
            } else {
                $('#value-3').removeClass('show');
            }
        }

        function loadFromURL() {
            const urlData = getURLParams();
            currentStep = Math.min(Math.max(urlData.step, 1), totalSteps);
            wizardData = {
                step1: urlData.step1,
                step2: urlData.step2,
                step3: urlData.step3
            };
            
            if (wizardData.step1) {
                $('#step-1 input').val(wizardData.step1);
            }
            if (wizardData.step2) {
                $('#step-2 .option-item[data-value="' + wizardData.step2 + '"]').addClass('selected');
            }
            if (wizardData.step3) {
                $('#step-3 .option-item[data-value="' + wizardData.step3 + '"]').addClass('selected');
            }
            updateStepValues();
        }

        function updateStepper() {
            $('.step').each(function(index) {
                const stepNum = index + 1;
                $(this).removeClass('active completed');

                if (stepNum < currentStep) {
                    $(this).addClass('completed');
                } else if (stepNum === currentStep) {
                    $(this).addClass('active');
                }
            });
        }

        function showStep(step) {
            $('.wizard-step').hide();
            $('#step-' + step).show();

            $('.step-number').removeClass('active');
            $('.step:nth-child(' + (step * 2 - 1) + ') .step-number').addClass('active');

            $('.step-value').removeClass('current');
            $('#value-' + step).addClass('current');

            if (step === 1) {
                $('#prev-button').hide();
            } else {
                $('#prev-button').show();
            }

            updateURL();
        }

        $('.option-item').click(function() {
            const parent = $(this).parent();
            parent.find('.option-item').removeClass('selected');
            $(this).addClass('selected');
        });

        function goToNextStep() {
            let isValid = false;

            if (currentStep === 1) {
                const stepInput = $('#step-' + currentStep + ' input');
                if (stepInput.length && stepInput.val().trim()) {
                    wizardData['step' + currentStep] = stepInput.val().trim();
                    isValid = true;
                }
            } else {
                const selectedOption = $('#step-' + currentStep + ' .option-item.selected');
                if (selectedOption.length) {
                    wizardData['step' + currentStep] = selectedOption.data('value');
                    isValid = true;
                }
            }

            if (!isValid) {
                alert('Please make a selection');
                return;
            }

            updateURL();
            updateStepValues();

            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
                $('#next-button').blur();
            } else {
                console.log('Creating dashboard with data:', wizardData);
                alert('Dashboard creation not implemented yet');
            }
        }

        $('#next-button').click(goToNextStep);

        $('input.input-field').on('keypress', function(e) {
            if (e.which === 13) {
                goToNextStep();
            }
        });

        $('#step-1 input').on('input', function() {
            const value = $(this).val().trim();
            if (value) {
                wizardData.step1 = value;
                updateStepValues();
            } else {
                delete wizardData.step1;
                updateStepValues();
            }
        });

        $('#prev-button').click(function() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        });

        loadFromURL();
        showStep(currentStep);
    });
</script>
{% endblock %}

{% block "content" %}

<div class="wizard-container">
    <div class="wizard-panel">
        <div class="wizard-layout">
            <div class="stepper">
                <div class="step-value" id="value-1"><div class="step-value-text"></div><div class="step-arrow">▶</div></div>
                <div class="step-value" id="value-2"><div class="step-value-text"></div><div class="step-arrow">▶</div></div>
                <div class="step-value" id="value-3"><div class="step-value-text"></div><div class="step-arrow">▶</div></div>
                <h1 class="wizard-title">Is it working?</h1>
                <div class="step">
                    <div class="step-number">1</div>
                </div>
                <div class="step-connector"></div>
                <div class="step">
                    <div class="step-number">2</div>
                </div>
                <div class="step-connector"></div>
                <div class="step">
                    <div class="step-number">3</div>
                </div>
            </div>

            <div class="wizard-content">
            <div id="step-1" class="wizard-step">
                <h1 class="question-title">1. What do you want to monitor?</h1>
                <input type="text" class="input-field" placeholder="Enter what you want to monitor..." />
            </div>

            <div id="step-2" class="wizard-step" style="display: none;">
                <h1 class="question-title">2. What do you want to track?</h1>
                <div class="option-group">
                    <div class="option-item" data-value="current-status">
                        <div class="option-radio"></div>
                        <div class="option-text">Current status</div>
                    </div>
                    <div class="option-item" data-value="error-rate">
                        <div class="option-radio"></div>
                        <div class="option-text">Error rate</div>
                    </div>
                    <div class="option-item" data-value="uptime">
                        <div class="option-radio"></div>
                        <div class="option-text">Uptime</div>
                    </div>
                    <div class="option-item" data-value="activity">
                        <div class="option-radio"></div>
                        <div class="option-text">Activity</div>
                    </div>
                </div>
            </div>

            <div id="step-3" class="wizard-step" style="display: none;">
                <h1 class="question-title">3. How far back to look?</h1>
                <div class="option-group">
                    <div class="option-item" data-value="real-time">
                        <div class="option-radio"></div>
                        <div class="option-text">Right now</div>
                    </div>
                    <div class="option-item" data-value="last-hour">
                        <div class="option-radio"></div>
                        <div class="option-text">Last hour</div>
                    </div>
                    <div class="option-item" data-value="last-day">
                        <div class="option-radio"></div>
                        <div class="option-text">Last day</div>
                    </div>
                    <div class="option-item" data-value="last-week">
                        <div class="option-radio"></div>
                        <div class="option-text">Last week</div>
                    </div>
                    <div class="option-item" data-value="last-month">
                        <div class="option-radio"></div>
                        <div class="option-text">Last month</div>
                    </div>
                </div>
            </div>

            <div class="wizard-buttons">
                <button id="prev-button" class="wizard-button">Previous</button>
                <button id="next-button" class="wizard-button">Next</button>
            </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
